#!/bin/bash

# Only check staged markdown files (added, copied, modified)
staged=$(git diff --cached --name-only --diff-filter=ACM -- '*.md')

if [ -z "$staged" ]; then
    exit 0
fi

# Format staged files and re-stage them
echo "$staged" | xargs prettier --write >/dev/null 2>&1
echo "$staged" | xargs git add

# Lint staged files
if ! echo "$staged" | xargs markdownlint --ignore .vale; then
    echo "markdownlint failed. Fix errors before committing."
    exit 1
fi

# Run vale on staged prose files (how/, why/, CLAUDE.md only)
prose=$(echo "$staged" | grep -E '^(how/|why/|CLAUDE\.md)')
if [ -n "$prose" ]; then
    if ! echo "$prose" | xargs vale; then
        echo "vale failed. Fix prose issues before committing."
        exit 1
    fi
fi

# Check internal links in staged files
if ! echo "$staged" | xargs lychee --offline 2>/dev/null; then
    echo "Broken links found. Fix before committing."
    exit 1
fi
