#!/bin/bash

# Format markdown files
prettier --write '**/*.md' --ignore-path .gitignore >/dev/null 2>&1

# Re-stage any formatted files
git diff --name-only | grep '\.md$' | xargs -r git add

# Run markdownlint
if ! markdownlint '**/*.md' --ignore .vale; then
    echo "markdownlint failed. Fix errors before committing."
    exit 1
fi

# Run vale
if ! vale how/*.md why/*.md CLAUDE.md; then
    echo "vale failed. Fix prose issues before committing."
    exit 1
fi

# Check internal links
if ! lychee --offline '**/*.md' 2>/dev/null; then
    echo "Broken links found. Fix before committing."
    exit 1
fi
